<Window x:Class="ScheduleApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:conv="clr-namespace:ScheduleApp.Converters"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:beh="clr-namespace:ScheduleApp.Behaviors"
        xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
        xmlns:local="clr-namespace:ScheduleApp"
        mc:Ignorable="d"
        Title="Support Coverage Scheduler"
        Height="600"
        Width="1200"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True"
        WindowStyle="None"
        ResizeMode="CanResize"
        AllowsTransparency="True"
        Background="Transparent">
    <Window.Resources>
        <!-- Converters and non-appearance resources -->
        <conv:HeaderCornerRadiusConverter x:Key="HeaderCornerRadiusConverter"/>
        <conv:HeaderBorderThicknessConverter x:Key="HeaderBorderThicknessConverter"/>
        <conv:RoundedClipConverter x:Key="RoundedClipConverter"/>

        <conv:TimeSpanToStringConverter x:Key="TimeSpanToStringConverter" />
        <conv:TaskKindToBrushConverter x:Key="TaskKindToBrushConverter"
                                   CoverageBrush="{StaticResource BrushCoverage}"
                                   BreakBrush="{StaticResource BrushBreak}"
                                   LunchBrush="{StaticResource BrushLunch}"
                                   IdleBrush="{StaticResource BrushIdle}"/>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:InverseBooleanToVisibilityConverter x:Key="BoolToVisInverse"/>
        <conv:NotNullToTrueConverter x:Key="NotNullToTrue"/>
        <conv:NotNullToFalseConverter x:Key="NotNullToFalse"/>

        <!-- Time item template -->
        <DataTemplate x:Key="TimeItemTemplate">
            <TextBlock Text="{Binding Converter={StaticResource TimeSpanToStringConverter}}"
                 Style="{StaticResource DefaultTextElementStyle}" />
        </DataTemplate>
        <conv:SupportTeacherDisplayConverter x:Key="SupportTeacherDisplayConverter"/>

        <!-- Default sort: Support view by Start (DateTime) -->
        <CollectionViewSource x:Key="SupportRowsView" Source="{Binding Schedule.SelectedSupportRows}">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="Start" Direction="Ascending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <!-- Default sort: Teacher view by SortKey (DateTime) -->
        <CollectionViewSource x:Key="TeacherRowsView" Source="{Binding Schedule.SelectedTeacherRows}">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="SortKey" Direction="Ascending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <!--
          Style that hides the tab headers while preserving TabControl behavior:
          - Keeps a zero-height, non-hit-testable TabPanel in the visual tree so the items host exists
            (helps maintain selection plumbing and accessibility providers).
          - Presents only the SelectedContent (SelectedContentHost).
          - Keeps the TabControl Focusable and keyboard/tab navigation intact for the content.
          -> For centralized theming, move this style into Appearance.xaml and reuse it.
        -->
        <Style x:Key="HiddenTabHeadersTabControl" TargetType="TabControl">
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Focusable" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabControl">
                        <Grid SnapsToDevicePixels="True">
                            <!-- Keep the TabPanel in the tree so TabItems are still generated
                                 and selection mechanics remain intact. Make it non-interactive and
                                 zero height so it does not change layout or render. -->
                            <TabPanel x:Name="HeaderPanel"
                                      IsItemsHost="True"
                                      Margin="0"
                                      Height="0"
                                      Opacity="0"
                                      IsHitTestVisible="False"
                                      KeyboardNavigation.TabIndex="0"/>

                            <!-- Content presenter shows the active tab's content -->
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    SnapsToDevicePixels="True"
                                    CornerRadius="8">
                                <ContentPresenter x:Name="PART_SelectedContentHost"
                                                  ContentSource="SelectedContent"
                                                  Margin="{TemplateBinding Padding}"
                                                  SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                                  Focusable="False"/>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>

            <!-- keep local keyboard navigation behavior; content remains focusable -->
            <Setter Property="KeyboardNavigation.TabNavigation" Value="Local"/>
        </Style>
        <conv:SupportTaskToBrushConverter x:Key="SupportTaskToBrushConverter"
                                  CoverageBrush="{StaticResource BrushCoverage}"
                                  BreakBrush="{StaticResource BrushBreak}"
                                  LunchBrush="{StaticResource BrushLunch}"
                                  IdleBrush="{StaticResource BrushIdle}"
                                  UnscheduledBrush="{StaticResource BrushUnscheduled}"/>
    </Window.Resources>

    <Grid>
        <DockPanel LastChildFill="True">
            <!-- Top-aligned navy title bar with hamburger -->
            <Border DockPanel.Dock="Top"
              CornerRadius="{StaticResource TopBarCornerRadius}"
              Background="{StaticResource TitleBarBackgroundBrush}"
              BorderBrush="{StaticResource TitleBarBorderBrush}"
              BorderThickness="{StaticResource GridOuterBorderThickness}"
              Padding="{StaticResource TopBarPadding}"
              SnapsToDevicePixels="True"
              Margin="{StaticResource TopBarOuterMargin}"
              MinHeight="{StaticResource TopBarMinHeight}"
              MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <ToggleButton x:Name="HamburgerToggle"
                        Grid.Column="0"
                        Style="{StaticResource HamburgerToggleButtonStyle}"/>

                    <!-- Title bar icon (named so code-behind can assign processed bitmap) -->
                    <Grid Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="8,0,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Image x:Name="TitleBarIcon"
                   Grid.Column="0"
                   Source="/ScheduleApp;component/washingtonstate.png"
                   Height="36"
                   Stretch="Uniform"
                   VerticalAlignment="Center"
                   SnapsToDevicePixels="True"/>

                        <!-- Two-space gap preserved before the text -->
                        <TextBlock Grid.Column="1"
                       xml:space="preserve"
                       Text="  Coverage Schedule App"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Left"
                       Foreground="White"
                       FontSize="16"
                       FontWeight="SemiBold"
                       IsHitTestVisible="False"/>
                    </Grid>

                    <Popup x:Name="HamburgerPopup"
                           PlacementTarget="{Binding ElementName=HamburgerToggle}"
                           Placement="Bottom"
                           AllowsTransparency="True"
                           StaysOpen="False"
                           IsOpen="{Binding IsChecked, ElementName=HamburgerToggle, Mode=TwoWay}"
                           Closed="HamburgerPopup_Closed">
                        <Border CornerRadius="{StaticResource PopupCornerRadius}"
                                Background="{StaticResource MenuBackgroundBrush}"
                                BorderBrush="{StaticResource MenuBorderBrush}"
                                BorderThickness="{StaticResource GridOuterBorderThickness}"
                                Padding="{StaticResource PopupPadding}"
                                SnapsToDevicePixels="True"
                                Margin="{StaticResource PopupMargin}"
                                Effect="{StaticResource PopupShadowEffect}"
                                MinWidth="200">
                            <StackPanel Orientation="Vertical">
                                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuSchedule_Click" Content="Schedule"/>
                                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuTeachers_Click" Content="Team Lineup"/>
                                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuPreview_Click" Content="Preview"/>
                                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuPreferences_Click" Content="Preferences"/>
                                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuExit_Click" Content="Exit"/>
                                <Separator Margin="{StaticResource PopupSeparatorMargin}"/>
                                <Button Style="{StaticResource MenuPopupButton}" Click="AboutMenu_Click" Content="About"/>
                            </StackPanel>
                        </Border>
                    </Popup>

                    <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                        <TextBlock Text="Saving…"
                       Margin="0,0,8,0"
                       VerticalAlignment="Center"
                       Foreground="{StaticResource TitleBarForegroundBrush}"
                       FontStyle="Italic"
                       FontSize="12"
                       Visibility="{Binding IsAutoSaving, Converter={StaticResource BoolToVis}}"
                       IsHitTestVisible="False"/>
                        <Button x:Name="MinimizeButton"
                    Style="{StaticResource TitleBarMinimizeButtonStyle}"
                    Click="Minimize_Click"
                    ToolTip="Minimize" />

                        <Button x:Name="MaximizeButton"
                    Style="{StaticResource TitleBarMaximizeButtonStyle}"
                    Click="MaximizeRestore_Click"
                    ToolTip="Maximize" />

                        <Button x:Name="CloseButton"
                    Style="{StaticResource TitleBarCloseButtonStyle}"
                    Click="Close_Click"
                    ToolTip="Close" />
                    </StackPanel>
                </Grid>
            </Border>

            <Border DockPanel.Dock="Top"
                    CornerRadius="{StaticResource AppPaneCornerRadius}"
                    Background="{StaticResource PrimaryBackgroundBrush}"
                    BorderBrush="{StaticResource PrimaryBorderBrush}"
                    BorderThickness="{StaticResource GridOuterBorderThickness}"
                    SnapsToDevicePixels="True"
                    Margin="{StaticResource AppPaneOuterMargin}"
                    Padding="{StaticResource WindowContentPadding}">
                <Grid>
                    <TabControl x:Name="MainTabControl"
                      Style="{StaticResource HiddenTabHeadersTabControl}"
                      AutomationProperties.Name="Main Content Tabs"
                      SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}"
                      SelectionChanged="MainTabControl_SelectionChanged">

                        <!-- 1) Schedule -->
                        <TabItem Header="Schedule">
                            <Grid Margin="{StaticResource PageSectionMarginLarge}">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Title row (actions moved into inner tabs) -->
                                <!-- NOTE: removed the parent ToolbarRowBottomMarginSmall so the title-to-inner-tab gap matches Team Lineup -->
                                <Grid Grid.Row="1" Margin="{StaticResource NoMarginThickness}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <Grid Grid.Column="0"
                                          VerticalAlignment="Center"
                                          Margin="{StaticResource TitleMarginBottomLarge}">
                                      <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                      </Grid.ColumnDefinitions>

                                      <!-- Named ScheduleTitleImage so code-behind can set processed bitmap -->
                                        <Border Grid.Column="0"
                                            BorderBrush="Black"
                                            BorderThickness="0"
                                            CornerRadius="4"
                                            VerticalAlignment="Center"
                                            SnapsToDevicePixels="True">
                                            <Image x:Name="ScheduleTitleImage"
                                                   Grid.Column="0"
                                                   Source="/ScheduleApp;component/washingtonstate.png"
                                                   Height="{StaticResource PageTitleFontSize}"
                                                   Stretch="Uniform"
                                                   VerticalAlignment="Center"
                                                   SnapsToDevicePixels="True"
                                                   RenderOptions.BitmapScalingMode="HighQuality">
                                                <Image.LayoutTransform>
                                                    <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                                                </Image.LayoutTransform>
                                                <Image.RenderTransform>
                                                    <TranslateTransform Y="4"/>
                                                </Image.RenderTransform>
                                            </Image>
                                        </Border>

                                        <TextBlock Grid.Column="1"
                                                 xml:space="preserve"
                                                 Text="  Schedule"
                                                 FontFamily="{StaticResource BodyFontFamily}"
                                                 FontSize="{StaticResource PageTitleFontSize}"
                                                 FontWeight="Normal"
                                                 Foreground="{StaticResource PrimaryTextBrush}"
                                                 VerticalAlignment="Center"/>
                                    </Grid>

                                    <!-- Filler (keeps layout consistent) -->
                                    <Border Grid.Column="1" Background="Transparent"/>

                                    <!-- Placeholder column kept empty so title baseline matches other pages -->
                                    <Border Grid.Column="2" Background="Transparent"/>
                                </Grid>

                                <!-- Main inner content -->
                                <local:ScheduleViewInnerTabContentControl x:Name="ScheduleViewInnerTabContentControl" Grid.Row="2" />
                            </Grid>
                        </TabItem>

                        <!-- 2) Team Lineup -->
                        <TabItem Header="Team Lineup">
                            <Grid Margin="{StaticResource PageSectionMarginLarge}">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Team Lineup title (explicit baseline for the other two) -->
                                <Grid Grid.Row="0"
                                      Margin="{StaticResource TitleMarginBottomLarge}"
                                      VerticalAlignment="Center">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Named TeamLineupTitleImage so code-behind can assign processed bitmap -->
                                    <Button Grid.Column="0"
                                            Style="{StaticResource HeaderImageButtonStyle}"
                                            Click="TitleBack_Click"
                                            ToolTip="Back to Schedule"
                                            HorizontalAlignment="Left"
                                            VerticalAlignment="Center"
                                            Focusable="False">
                                        <Image x:Name="TeamLineupTitleImage"
                                               Source="/ScheduleApp;component/arrow.png"
                                               Height="{StaticResource PageTitleFontSize}"
                                               Stretch="Uniform"
                                               VerticalAlignment="Center"
                                               SnapsToDevicePixels="True"
                                               RenderOptions.BitmapScalingMode="HighQuality">
                                            <Image.LayoutTransform>
                                                <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                                            </Image.LayoutTransform>
                                            <Image.RenderTransform>
                                                <TranslateTransform Y="2"/>
                                            </Image.RenderTransform>
                                        </Image>
                                    </Button>

                                    <TextBlock Grid.Column="1"
                                               xml:space="preserve"
                                               Text="  Team Lineup"
                                               FontFamily="{StaticResource BodyFontFamily}"
                                               FontSize="{StaticResource PageTitleFontSize}"
                                               FontWeight="Normal"
                                               Foreground="{StaticResource PrimaryTextBrush}"
                                               VerticalAlignment="Center"/>
                                </Grid>

                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TabControl x:Name="TeamLineupInnerTab" Grid.Column="0" Margin="{StaticResource RightColumnGapLarge}">
                                        <TabItem Header="Classrooms and Teachers">
                                            <Grid Margin="{StaticResource PageSectionMarginLarge}">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <ContentControl Grid.Column="0"
                                        Style="{StaticResource RoundedTableContainer}"
                                        Margin="{StaticResource NoMarginThreshold}"
                                        VerticalContentAlignment="Stretch">
                                                    <DataGrid x:Name="TeachersGrid"
                                                              ItemsSource="{Binding Setup.Teachers}"
                                                              AutoGenerateColumns="False"
                                                              CanUserAddRows="False"
                                                              CanUserSortColumns="True"
                                                              HeadersVisibility="Column"
                                                              SelectionMode="Extended"
                                                              SelectionUnit="FullRow"
                                                              GridLinesVisibility="Horizontal"
                                                              HorizontalGridLinesBrush="{StaticResource SchedGridLineBrush}"
                                                              SnapsToDevicePixels="True"
                                                              BorderThickness="{StaticResource NoBorderThickness}"
                                                              Background="{StaticResource TransparentBrush}"
                                                              ColumnHeaderStyle="{StaticResource RoundedDataGridColumnHeader}"
                                                              beh:DataGridRowReorderBehavior.EnableRowReorder="True"
                                                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                              ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                                              VerticalAlignment="Stretch"
                                                              RowEditEnding="SetupDataGrid_RowEditEnding"
                                                              CellEditEnding="SetupDataGrid_CellEditEnding">
                                                        <DataGrid.InputBindings>
                                                            <KeyBinding Key="Up" 
                                                                        Modifiers="Control"
                                                                        Command="{Binding DataContext.Setup.MoveTeacherUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                            <KeyBinding Key="Down" 
                                                                        Modifiers="Control"
                                                                        Command="{Binding DataContext.Setup.MoveTeacherDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                        </DataGrid.InputBindings>

                                                        <DataGrid.Resources>
                                                            <Style TargetType="{x:Type DataGridColumnHeadersPresenter}">
                                                                <Setter Property="Background" Value="{StaticResource TransparentBrush}"/>
                                                                <Setter Property="SnapsToDevicePixels" Value="True"/>
                                                                <Setter Property="ClipToBounds" Value="True"/>
                                                            </Style>
                                                        </DataGrid.Resources>

                                                        <DataGrid.Columns>
                                                            <DataGridTextColumn Header="Room Number"
                                                                                Binding="{Binding RoomNumber}"
                                                                                SortMemberPath="RoomNumber"
                                                                                Width="*"
                                                                                CellStyle="{StaticResource DefaultCellStyle}"
                                                                                ElementStyle="{StaticResource DefaultTextElementStyle}"
                                                                                EditingElementStyle="{StaticResource DefaultEditingElementStyle}"/>
                                                            <DataGridTextColumn Header="Teacher Name"
                                                                                Binding="{Binding Name}"
                                                                                SortMemberPath="Name"
                                                                                Width="*"
                                                                                CellStyle="{StaticResource DefaultCellStyle}"
                                                                                ElementStyle="{StaticResource DefaultTextElementStyle}"
                                                                                EditingElementStyle="{StaticResource DefaultEditingElementStyle}"/>
                                                            <DataGridTemplateColumn Header="Start Time"
                                                                                    SortMemberPath="Start"
                                                                                    Width="*"
                                                                                    CellStyle="{StaticResource DefaultCellStyle}">
                                                                <DataGridTemplateColumn.CellTemplate>
                                                                    <DataTemplate>
                                                                        <TextBlock Text="{Binding Start, Converter={StaticResource TimeSpanToStringConverter}}"
                                                                                   Style="{StaticResource DefaultTextElementStyle}"/>
                                                                    </DataTemplate>
                                                                </DataGridTemplateColumn.CellTemplate>
                                                                <DataGridTemplateColumn.CellEditingTemplate>
                                                                    <DataTemplate>
                                                                        <ComboBox ItemsSource="{Binding DataContext.QuarterHours, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                  SelectedItem="{Binding Start, Mode=TwoWay}"
                                                                                  ItemTemplate="{StaticResource TimeItemTemplate}"
                                                                                  MinWidth="120"
                                                                                  Padding="{StaticResource CellEditorPadding}"
                                                                                  Style="{StaticResource DefaultEditingComboBoxStyle}"/>
                                                                    </DataTemplate>
                                                                </DataGridTemplateColumn.CellEditingTemplate>
                                                            </DataGridTemplateColumn>

                                                            <DataGridTemplateColumn Header="End Time" 
                                                                                    SortMemberPath="End" 
                                                                                    Width="*"
                                                                                    CellStyle="{StaticResource LastColumnCellStyle}">
                                                                <DataGridTemplateColumn.CellTemplate>
                                                                    <DataTemplate>
                                                                        <TextBlock Text="{Binding End, Converter={StaticResource TimeSpanToStringConverter}}"
                                                                                   Style="{StaticResource DefaultTextElementStyle}"/>
                                                                    </DataTemplate>
                                                                </DataGridTemplateColumn.CellTemplate>
                                                                <DataGridTemplateColumn.CellEditingTemplate>
                                                                    <DataTemplate>
                                                                        <ComboBox ItemsSource="{Binding DataContext.QuarterHours, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                  SelectedItem="{Binding End, Mode=TwoWay}"
                                                                                  ItemTemplate="{StaticResource TimeItemTemplate}"
                                                                                  MinWidth="120"
                                                                                  Padding="{StaticResource CellEditorPadding}"
                                                                                  Style="{StaticResource DefaultEditingComboBoxStyle}"/>
                                                                    </DataTemplate>
                                                                </DataGridTemplateColumn.CellEditingTemplate>
                                                            </DataGridTemplateColumn>
                                                        </DataGrid.Columns>
                                                    </DataGrid>
                                                </ContentControl>

                                                <StackPanel Grid.Column="1"
                                                            Orientation="Vertical"
                                                            Margin="{StaticResource SidePanelLeftMargin}"
                                                            VerticalAlignment="Top">
                                                    <Button Content="Add"
                                                            Style="{StaticResource RoundedActionButton}"
                                                            Margin="{StaticResource ActionButtonStackMargin}"
                                                            Command="{Binding Setup.AddTeacherCommand}"/>
                                                    <Button Content="Remove"
                                                            Style="{StaticResource RoundedActionButton}"
                                                            Margin="{StaticResource ActionButtonStackMarginNone}"
                                                            Command="{Binding Setup.RemoveTeacherCommand}"
                                                            CommandParameter="{Binding SelectedItems, ElementName=TeachersGrid}"/>
                                                </StackPanel>
                                            </Grid>
                                        </TabItem>

                                        <TabItem Header="Support Staff">
                                            <Grid Margin="{StaticResource PageSectionMarginLarge}">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <ContentControl Grid.Column="0"
                                                                Style="{StaticResource RoundedTableContainer}"
                                                                Margin="{StaticResource NoMarginThickness}"
                                                                VerticalContentAlignment="Stretch">
                                                    <DataGrid x:Name="SupportsGrid"
                                                              ItemsSource="{Binding Setup.Supports}"
                                                              SelectedItem="{Binding Setup.SelectedSupport}"
                                                              AutoGenerateColumns="False"
                                                              CanUserAddRows="False"
                                                              CanUserSortColumns="True"
                                                              HeadersVisibility="Column"
                                                              SelectionMode="Extended"
                                                              SelectionUnit="FullRow"
                                                              GridLinesVisibility="Horizontal"
                                                              HorizontalGridLinesBrush="{StaticResource SchedGridLineBrush}"
                                                              SnapsToDevicePixels="True"
                                                              BorderThickness="{StaticResource NoBorderThickness}"
                                                              Background="{StaticResource TransparentBrush}"
                                                              ColumnHeaderStyle="{StaticResource RoundedDataGridColumnHeader}"
                                                              beh:DataGridRowReorderBehavior.EnableRowReorder="True"
                                                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                              ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                                              VerticalAlignment="Stretch"
                                                              RowEditEnding="SetupDataGrid_RowEditEnding"
                                                              CellEditEnding="SetupDataGrid_CellEditEnding">
                                                        <DataGrid.InputBindings>
                                                            <KeyBinding Key="Up" 
                                                                        Modifiers="Control"
                                                                        Command="{Binding DataContext.Setup.MoveSupportUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                            <KeyBinding Key="Down" 
                                                                        Modifiers="Control"
                                                                        Command="{Binding DataContext.Setup.MoveSupportDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                        </DataGrid.InputBindings>

                                                        <DataGrid.Columns>
                                                            <DataGridTextColumn Header="Support Staff"
                                                                                Binding="{Binding Name}"
                                                                                SortMemberPath="Name"
                                                                                Width="*"
                                                                                CellStyle="{StaticResource DefaultCellStyle}" />
                                                            <DataGridTemplateColumn Header="Start Time"
                                                                                    SortMemberPath="Start"
                                                                                    Width="*"
                                                                                    CellStyle="{StaticResource DefaultCellStyle}">
                                                                <DataGridTemplateColumn.CellTemplate>
                                                                    <DataTemplate>
                                                                        <TextBlock Text="{Binding Start, Converter={StaticResource TimeSpanToStringConverter}}"
                                                                                   Style="{StaticResource DefaultTextElementStyle}"/>
                                                                    </DataTemplate>
                                                                </DataGridTemplateColumn.CellTemplate>
                                                                <DataGridTemplateColumn.CellEditingTemplate>
                                                                    <DataTemplate>
                                                                        <ComboBox ItemsSource="{Binding DataContext.QuarterHours, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                  SelectedItem="{Binding Start, Mode=TwoWay}"
                                                                                  ItemTemplate="{StaticResource TimeItemTemplate}"
                                                                                  MinWidth="120"
                                                                                  Padding="{StaticResource CellEditorPadding}"
                                                                                  Style="{StaticResource DefaultEditingComboBoxStyle}"/>
                                                                    </DataTemplate>
                                                                </DataGridTemplateColumn.CellEditingTemplate>
                                                            </DataGridTemplateColumn>

                                                            <DataGridTemplateColumn Header="End Time"
                                                                                    SortMemberPath="End"
                                                                                    Width="*"
                                                                                    CellStyle="{StaticResource LastColumnCellStyle}">
                                                                <DataGridTemplateColumn.CellTemplate>
                                                                    <DataTemplate>
                                                                        <TextBlock Text="{Binding End, Converter={StaticResource TimeSpanToStringConverter}}"
                                                                                   Style="{StaticResource DefaultTextElementStyle}"/>
                                                                    </DataTemplate>
                                                                </DataGridTemplateColumn.CellTemplate>
                                                                <DataGridTemplateColumn.CellEditingTemplate>
                                                                    <DataTemplate>
                                                                        <ComboBox ItemsSource="{Binding DataContext.QuarterHours, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                  SelectedItem="{Binding End, Mode=TwoWay}"
                                                                                  ItemTemplate="{StaticResource TimeItemTemplate}"
                                                                                  MinWidth="120"
                                                                                  Padding="{StaticResource CellEditorPadding}"/>
                                                                    </DataTemplate>
                                                                </DataGridTemplateColumn.CellEditingTemplate>
                                                            </DataGridTemplateColumn>
                                                        </DataGrid.Columns>
                                                    </DataGrid>
                                                </ContentControl>

                                                <StackPanel Grid.Column="1"
                                                            Orientation="Vertical"
                                                            Margin="{StaticResource SidePanelLeftMargin}"
                                                            VerticalAlignment="Top">
                                                    <Button Content="Add"
                                                            Style="{StaticResource RoundedActionButton}"
                                                            Margin="{StaticResource ActionButtonStackMargin}"
                                                            Command="{Binding Setup.AddSupportCommand}"/>
                                                    <Button Content="Remove"
                                                            Style="{StaticResource RoundedActionButton}"
                                                            Margin="{StaticResource ActionButtonStackMarginNone}"
                                                            Command="{Binding Setup.RemoveSupportCommand}"
                                                            CommandParameter="{Binding SelectedItems, ElementName=SupportsGrid}"/>
                                                </StackPanel>
                                            </Grid>
                                        </TabItem>
                                    </TabControl>
                                </Grid>
                            </Grid>
                        </TabItem>

                        <!-- 3) Preview (was "Print Preview") -->
                        <TabItem Header="Preview">
                            <Grid Margin="{StaticResource PageSectionMarginLarge}">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <Grid Grid.Row="0"
                                      Margin="{StaticResource TitleMarginBottomLarge}"
                                      VerticalAlignment="Center">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Print Preview page title image (arrow.png) -->
                                    <Button Grid.Column="0"
                                            Style="{StaticResource HeaderImageButtonStyle}"
                                            Click="TitleBack_Click"
                                            ToolTip="Back to Schedule"
                                            HorizontalAlignment="Left"
                                            VerticalAlignment="Center"
                                            Focusable="False">
                                        <Image x:Name="PrintPreviewTitleImage"
                                               Source="/ScheduleApp;component/arrow.png"
                                               Height="{StaticResource PageTitleFontSize}"
                                               Stretch="Uniform"
                                               VerticalAlignment="Center"
                                               SnapsToDevicePixels="True"
                                               RenderOptions.BitmapScalingMode="HighQuality">
                                        <Image.LayoutTransform>
                                            <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                                        </Image.LayoutTransform>
                                        <Image.RenderTransform>
                                            <TranslateTransform Y="2"/>
                                        </Image.RenderTransform>
                                      </Image>
                                    </Button>

                                    <TextBlock Grid.Column="1"
                                               xml:space="preserve"
                                               Text="  Preview"
                                               FontFamily="{StaticResource BodyFontFamily}"
                                               FontSize="{StaticResource PageTitleFontSize}"
                                               FontWeight="Normal"
                                               Foreground="{StaticResource PrimaryTextBrush}"
                                               VerticalAlignment="Center"/>
                                </Grid>

                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <ContentControl Grid.Column="0"
                                                    Style="{StaticResource RoundedTableContainer}"
                                                    Margin="{StaticResource NoMarginThickness}"
                                                    VerticalContentAlignment="Stretch">
                                        <Grid Margin="16">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>

                                            <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="{StaticResource ToolbarRowBottomMarginSmall}">
                                                <ComboBox Width="200"
                                                          ItemsSource="{Binding Schedule.SupportTabs}"
                                                          DisplayMemberPath="SupportName"
                                                          SelectedItem="{Binding PrintPreview.SelectedTab}" />
                                                <Button Content="Print Selected" Style="{StaticResource IconButton}" Command="{Binding PrintPreview.PrintSelectedCommand}" Margin="{StaticResource ToolbarButtonMarginSmall}"/>
                                            </StackPanel>

                                            <FlowDocumentScrollViewer x:Name="PrintPreviewViewer"
                                                                      Grid.Row="1"
                                                                      Document="{Binding PrintPreview.Document}"
                                                                      Focusable="True"
                                                                      PreviewMouseLeftButtonDown="ScheduleArea_PreviewMouseLeftButtonDown" />
                                        </Grid>
                                    </ContentControl>
                                </Grid>
                            </Grid>
                        </TabItem>

                        <!-- 4) Preferences -->
                        <TabItem Header="Preferences">
                            <Grid Margin="{StaticResource PageSectionMarginLarge}">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Header (kept consistent with other tabs) -->
                                <!-- Preferences title: replace the single TextBlock with this to match Schedule/Team Lineup -->
                                <Grid Grid.Row="0"
                                      Margin="{StaticResource TitleMarginBottomLarge}"
                                      VerticalAlignment="Center">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Named PreferencesTitleImage so code-behind can assign processed bitmap -->
                                    <Button Grid.Column="0"
                                            Style="{StaticResource HeaderImageButtonStyle}"
                                            Click="TitleBack_Click"
                                            ToolTip="Back to Schedule"
                                            HorizontalAlignment="Left"
                                            VerticalAlignment="Center"
                                            Focusable="False">
                                        <Image x:Name="PreferencesTitleImage"
                                               Source="/ScheduleApp;component/arrow.png"
                                               Height="{StaticResource PageTitleFontSize}"
                                               Stretch="Uniform"
                                               VerticalAlignment="Center"
                                               SnapsToDevicePixels="True"
                                               RenderOptions.BitmapScalingMode="HighQuality">
                                            <Image.LayoutTransform>
                                                <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                                            </Image.LayoutTransform>
                                            <Image.RenderTransform>
                                                <TranslateTransform Y="2"/>
                                            </Image.RenderTransform>
                                        </Image>
                                     </Button>

                                    <TextBlock Grid.Column="1"
                                               xml:space="preserve"
                                               Text="  Preferences"
                                               FontFamily="{StaticResource BodyFontFamily}"
                                               FontSize="{StaticResource PageTitleFontSize}"
                                               FontWeight="Normal"
                                               Foreground="{StaticResource PrimaryTextBrush}"
                                               VerticalAlignment="Center"/>
                                </Grid>

                                <!-- Match Team Lineup structure: rounded container + comfy inner padding -->
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <ContentControl Grid.Column="0"
                                                    Style="{StaticResource RoundedTableContainer}"
                                                    Margin="{StaticResource NoMarginThickness}"
                                                    VerticalContentAlignment="Stretch">
                                        <!-- Inner form layout spacing mirrors Team Lineup section spacing -->
                                        <Grid Margin="{StaticResource PageSectionMarginLarge}">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <TextBlock Grid.Row="0" 
                                                       Grid.Column="0"
                                                       Margin="{StaticResource FormLabelMargin}"
                                                       VerticalAlignment="Center"
                                                       Text="School Name"/>
                                            <TextBox   Grid.Row="0" Grid.Column="1"
                                                       Margin="{StaticResource FormFieldMarginBottom}"
                                                       Text="{Binding Setup.SchoolName, UpdateSourceTrigger=PropertyChanged}"/>

                                            <TextBlock Grid.Row="1" Grid.Column="0"
                                                       Margin="{StaticResource FormLabelMargin}"
                                                       VerticalAlignment="Top"
                                                       Text="Address"/>
                                            <TextBox   Grid.Row="1" Grid.Column="1"
                                                       Margin="{StaticResource FormFieldMarginBottom}"
                                                       Text="{Binding Setup.SchoolAddress, UpdateSourceTrigger=PropertyChanged}"
                                                       AcceptsReturn="True"
                                                       TextWrapping="Wrap"
                                                       VerticalScrollBarVisibility="Auto"
                                                       MinLines="4"
                                                       MaxLines="4"/>

                                            <TextBlock Grid.Row="2" 
                                                       Grid.Column="0"
                                                       Margin="{StaticResource FormLabelMarginLastRow}"
                                                       VerticalAlignment="Center"
                                                       Text="Telephone"/>
                                            <TextBox Grid.Row="2" 
                                                     Grid.Column="1"
                                                     Text="{Binding Setup.SchoolPhone, UpdateSourceTrigger=PropertyChanged}"/>

                                            <Border Grid.Row="3" 
                                                    Grid.Column="0" 
                                                    Grid.ColumnSpan="2"
                                                    Height="1"
                                                    Background="{StaticResource SchedGridLineBrush}"
                                                    SnapsToDevicePixels="True"
                                                    Margin="24,24,24,24"
                                                    HorizontalAlignment="Stretch"/>

                                            <TextBlock Grid.Row="4" 
                                                       Grid.Column="0"
                                                       Margin="{StaticResource FormLabelMarginLastRow}"
                                                       VerticalAlignment="Center"
                                                       Text="Schedule Save Folder"/>

                                            <Grid Grid.Row="4" 
                                                  Grid.Column="1" 
                                                  Margin="{StaticResource FormFieldMarginBottom}">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBox Grid.Column="0"
                                                         Text="{Binding Setup.SaveFolder, UpdateSourceTrigger=PropertyChanged}"
                                                         VerticalAlignment="Center"/>

                                                <Button Grid.Column="1"
                                                        Content="Browse…"
                                                        Style="{StaticResource RoundedActionButtonSmallRadius}"
                                                        Margin="8,0,8,0"
                                                        MinWidth="68"
                                                        HorizontalContentAlignment="Center"
                                                        VerticalContentAlignment="Center"
                                                        Command="{Binding Setup.BrowseSaveFolderCommand}"/>

                                                <Button Grid.Column="2"
                                                        Content="Explore"
                                                        Style="{StaticResource RoundedActionButtonSmallRadius}"
                                                        MinWidth="68"
                                                        HorizontalContentAlignment="Center"
                                                        VerticalContentAlignment="Center"
                                                        Command="{Binding Setup.ExploreSaveFolderCommand}"/>
                                            </Grid>
                                        </Grid>
                                    </ContentControl>
                                </Grid>
                            </Grid>
                        </TabItem>

                    </TabControl>
                </Grid>
            </Border>
        </DockPanel>

        <Grid x:Name="ResizeOverlay"
              Margin="3"
              Background="{x:Null}"
              IsHitTestVisible="True"
              ClipToBounds="True"
              Panel.ZIndex="10000"
              HorizontalAlignment="Stretch"
              VerticalAlignment="Stretch"
              SnapsToDevicePixels="True">

            <Thumb x:Name="ThumbLeft" Background="Transparent" Style="{StaticResource InvisibleResizeThumbStyle}" IsHitTestVisible="True" Tag="Left" Width="8" HorizontalAlignment="Left" VerticalAlignment="Stretch" Cursor="SizeWE" PreviewMouseDown="ResizeThumb_PreviewMouseDown" DragDelta="ThumbLeft_DragDelta"/>
            <Thumb x:Name="ThumbRight" Background="Transparent" Style="{StaticResource InvisibleResizeThumbStyle}" IsHitTestVisible="True" Tag="Right" Width="8" HorizontalAlignment="Right" VerticalAlignment="Stretch" Cursor="SizeWE" PreviewMouseDown="ResizeThumb_PreviewMouseDown" DragDelta="ThumbRight_DragDelta"/>
            <Thumb x:Name="ThumbTop" Background="Transparent" Style="{StaticResource InvisibleResizeThumbStyle}" IsHitTestVisible="True" Tag="Top" Height="6" HorizontalAlignment="Stretch" VerticalAlignment="Top" Cursor="SizeNS" PreviewMouseDown="ResizeThumb_PreviewMouseDown" DragDelta="ThumbTop_DragDelta"/>
            <Thumb x:Name="ThumbBottom" Background="Transparent" Style="{StaticResource InvisibleResizeThumbStyle}" IsHitTestVisible="True" Tag="Bottom" Height="6" HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Cursor="SizeNS" PreviewMouseDown="ResizeThumb_PreviewMouseDown" DragDelta="ThumbBottom_DragDelta"/>
            <Thumb x:Name="ThumbTopLeft" Background="Transparent" Style="{StaticResource InvisibleResizeThumbStyle}" IsHitTestVisible="True" Tag="TopLeft" Width="12" Height="12" HorizontalAlignment="Left" VerticalAlignment="Top" Cursor="SizeNWSE" PreviewMouseDown="ResizeThumb_PreviewMouseDown" DragDelta="ThumbTopLeft_DragDelta"/>
            <Thumb x:Name="ThumbTopRight" Background="Transparent" Style="{StaticResource InvisibleResizeThumbStyle}" IsHitTestVisible="True" Tag="TopRight" Width="12" Height="12" HorizontalAlignment="Right" VerticalAlignment="Top" Cursor="SizeNESW" PreviewMouseDown="ResizeThumb_PreviewMouseDown" DragDelta="ThumbTopRight_DragDelta"/>
            <Thumb x:Name="ThumbBottomLeft" Background="Transparent" Style="{StaticResource InvisibleResizeThumbStyle}" IsHitTestVisible="True" Tag="BottomLeft" Width="12" Height="12" HorizontalAlignment="Left" VerticalAlignment="Bottom" Cursor="SizeNESW" PreviewMouseDown="ResizeThumb_PreviewMouseDown" DragDelta="ThumbBottomLeft_DragDelta"/>
            <Thumb x:Name="ThumbBottomRight" Background="Transparent" Style="{StaticResource InvisibleResizeThumbStyle}" IsHitTestVisible="True" Tag="BottomRight" Width="12" Height="12" HorizontalAlignment="Right" VerticalAlignment="Bottom" Cursor="SizeNWSE" PreviewMouseDown="ResizeThumb_PreviewMouseDown" DragDelta="ThumbBottomRight_DragDelta"/>
        </Grid>
    </Grid>
</Window>