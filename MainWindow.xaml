<Window x:Class="ScheduleApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:conv="clr-namespace:ScheduleApp.Converters"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:beh="clr-namespace:ScheduleApp.Behaviors"
        mc:Ignorable="d"
        Title="Support Coverage Scheduler"
        Height="600"
        Width="1200"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True"
        WindowStyle="None"
        ResizeMode="CanResize"
        AllowsTransparency="True"
        Background="Transparent">
  <Window.Resources>
    <!-- Converters and non-appearance resources -->
    <conv:HeaderCornerRadiusConverter x:Key="HeaderCornerRadiusConverter"/>
    <conv:HeaderBorderThicknessConverter x:Key="HeaderBorderThicknessConverter"/>
    <conv:RoundedClipConverter x:Key="RoundedClipConverter"/>

    <conv:TimeSpanToStringConverter x:Key="TimeSpanToStringConverter" />
    <conv:TaskKindToBrushConverter x:Key="TaskKindToBrushConverter"
                                   CoverageBrush="{StaticResource BrushCoverage}"
                                   BreakBrush="{StaticResource BrushBreak}"
                                   LunchBrush="{StaticResource BrushLunch}"
                                   IdleBrush="{StaticResource BrushIdle}"/>
    <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    <conv:InverseBooleanToVisibilityConverter x:Key="BoolToVisInverse"/>
    <conv:NotNullToTrueConverter x:Key="NotNullToTrue"/>
    <conv:NotNullToFalseConverter x:Key="NotNullToFalse"/>

    <!-- Time item template -->
    <DataTemplate x:Key="TimeItemTemplate">
      <TextBlock Text="{Binding Converter={StaticResource TimeSpanToStringConverter}}" />
    </DataTemplate>
    <conv:SupportTeacherDisplayConverter x:Key="SupportTeacherDisplayConverter"/>
  </Window.Resources>

  <Grid>
    <DockPanel LastChildFill="True">
      <!-- Top-aligned navy title bar with hamburger -->
      <Border DockPanel.Dock="Top"
              CornerRadius="{StaticResource TopBarCornerRadius}"
              Background="{StaticResource TitleBarBackgroundBrush}"
              BorderBrush="{StaticResource TitleBarBorderBrush}"
              BorderThickness="{StaticResource GridOuterBorderThickness}"
              Padding="{StaticResource TopBarPadding}"
              SnapsToDevicePixels="True"
              Margin="{StaticResource TopBarOuterMargin}"
              MinHeight="{StaticResource TopBarMinHeight}"
              MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
          </Grid.ColumnDefinitions>

          <ToggleButton x:Name="HamburgerToggle"
                        Grid.Column="0"
                        Style="{StaticResource HamburgerToggleButtonStyle}"/>

          <TextBlock Grid.Column="1"
                     Text="Coverage Schedule App"
                     VerticalAlignment="Center"
                     HorizontalAlignment="Left"
                     Margin="8,0,0,0"
                     Foreground="{StaticResource TitleBarForegroundBrush}"
                     FontSize="16"
                     FontWeight="SemiBold"
                     IsHitTestVisible="False"/>

          <Popup x:Name="HamburgerPopup"
                 PlacementTarget="{Binding ElementName=HamburgerToggle}"
                 Placement="Bottom"
                 AllowsTransparency="True"
                 StaysOpen="False"
                 IsOpen="{Binding IsChecked, ElementName=HamburgerToggle, Mode=TwoWay}"
                 Closed="HamburgerPopup_Closed">
            <Border CornerRadius="{StaticResource PopupCornerRadius}"
                    Background="{StaticResource MenuBackgroundBrush}"
                    BorderBrush="{StaticResource MenuBorderBrush}"
                    BorderThickness="{StaticResource GridOuterBorderThickness}"
                    Padding="{StaticResource PopupPadding}"
                    SnapsToDevicePixels="True"
                    Margin="{StaticResource PopupMargin}"
                    Effect="{StaticResource PopupShadowEffect}"
                    MinWidth="200">
              <StackPanel Orientation="Vertical">
                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuSchedule_Click" Content="Schedule"/>
                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuPreview_Click" Content="Preview"/>
                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuTeachers_Click" Content="Teachers"/>
                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuPreferences_Click" Content="Preferences"/>
                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuAlgorithm_Click" Content="Algorithm"/>
                <Button Style="{StaticResource MenuPopupButton}" Margin="{StaticResource PopupMenuItemMargin}" Click="MenuExit_Click" Content="Exit"/>
                <Separator Margin="{StaticResource PopupSeparatorMargin}"/>
                <Button Style="{StaticResource MenuPopupButton}" Click="AboutMenu_Click" Content="About"/>
              </StackPanel>
            </Border>
          </Popup>

          <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
            <Button x:Name="MinimizeButton"
                    Style="{StaticResource TitleBarMinimizeButtonStyle}"
                    Click="Minimize_Click"
                    ToolTip="Minimize" />

            <Button x:Name="MaximizeButton"
                    Style="{StaticResource TitleBarMaximizeButtonStyle}"
                    Click="MaximizeRestore_Click"
                    ToolTip="Maximize" />

            <Button x:Name="CloseButton"
                    Style="{StaticResource TitleBarCloseButtonStyle}"
                    Click="Close_Click"
                    ToolTip="Close" />
          </StackPanel>
        </Grid>
      </Border>

      <Border DockPanel.Dock="Top"
              CornerRadius="{StaticResource AppPaneCornerRadius}"
              Background="{StaticResource PrimaryBackgroundBrush}"
              BorderBrush="{StaticResource PrimaryBorderBrush}"
              BorderThickness="{StaticResource GridOuterBorderThickness}"
              SnapsToDevicePixels="True"
              Margin="{StaticResource AppPaneOuterMargin}"
              Padding="{StaticResource WindowContentPadding}">
        <Grid>
          <TabControl x:Name="MainTabControl"
                      SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}"
                      SelectionChanged="MainTabControl_SelectionChanged">

            <!-- 1) Schedule -->
            <TabItem Header="Schedule">
              <Grid Margin="{StaticResource PageSectionMarginSmall}">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Grid Grid.Row="0" Margin="{StaticResource ToolbarRowBottomMarginSmall}">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>

                  <StackPanel Orientation="Horizontal" Grid.Column="0" VerticalAlignment="Center">
                    <Button Content="Save…" Style="{StaticResource IconButton}"
                            Command="{Binding SaveScheduleCommand}"
                            Margin="{StaticResource NoMarginNothing}"/>
                    <TextBlock Text="Each tab shows a support's day. Waiting time counts as working time."
                               VerticalAlignment="Center" Margin="{StaticResource SidePanelLeftMargin}"/>
                  </StackPanel>

                  <StackPanel Orientation="Horizontal" Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Right">
                    <Border Background="{StaticResource BrushCoverage}" Style="{StaticResource PillStyle}">
                      <TextBlock Text="Coverage" />
                    </Border>
                    <Border Background="{StaticResource BrushBreak}" Style="{StaticResource PillStyle}">
                      <TextBlock Text="Break (10m + 5m buffer)" />
                    </Border>
                    <Border Background="{StaticResource BrushLunch}" Style="{StaticResource PillStyle}">
                      <TextBlock Text="Lunch (30m)" />
                    </Border>
                    <Border Background="{StaticResource BrushIdle}" Style="{StaticResource PillStyle}">
                      <TextBlock Text="Free" />
                    </Border>
                    <Border Background="{StaticResource BrushUnscheduled}" Style="{StaticResource PillStyle}">
                      <TextBlock Text="Unscheduled" />
                    </Border>
                  </StackPanel>
                </Grid>

                <Border Grid.Row="1"
                        Margin="20"
                        Padding="6"
                        Background="{StaticResource PrimaryBackgroundBrush}"
                        CornerRadius="0,6,6,6"
                        SnapsToDevicePixels="True"
                        ClipToBounds="True">
                  <TabControl x:Name="ScheduleViewInnerTabControl"
                              SelectionChanged="ScheduleViewInnerTabControl_SelectionChanged">
                    <TabItem Header="By Support">
                      <!-- By Support layout -->
                      <Grid Margin="20">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="260"/>
                          <ColumnDefinition Width="16"/>
                          <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Style="{StaticResource RoundedTableBorder}" Margin="{StaticResource NoMarginNothing}">
                          <ListBox x:Name="SupportListBox"
                                   beh:AutoSelectFirstBehavior.EnableAutoSelect="True"
                                   ItemsSource="{Binding Schedule.SupportEntries}"
                                   SelectionMode="Extended"
                                   SelectionChanged="SupportListBox_SelectionChanged"
                                   ScrollViewer.VerticalScrollBarVisibility="Auto"
                                   Background="{StaticResource TransparentBrush}"
                                   BorderThickness="0"
                                   IsSynchronizedWithCurrentItem="False"
                                   ItemContainerStyle="{StaticResource RoundedListBoxItemStyle}">
                            <ListBox.ItemTemplate>
                              <DataTemplate>
                                <Grid Margin="{StaticResource CellElementMargin}">
                                  <TextBlock Text="{Binding Name}" FontWeight="SemiBold" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                      <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="{StaticResource PrimaryTextBrush}"/>
                                        <Setter Property="FontStyle" Value="Normal"/>
                                        <Style.Triggers>
                                          <DataTrigger Binding="{Binding IsUnscheduled}" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource SecondaryTextBrush}"/>
                                            <Setter Property="FontStyle" Value="Italic"/>
                                          </DataTrigger>
                                        </Style.Triggers>
                                      </Style>
                                    </TextBlock.Style>
                                  </TextBlock>
                                </Grid>
                              </DataTemplate>
                            </ListBox.ItemTemplate>
                          </ListBox>
                        </Border>

                        <Border Grid.Column="2" Style="{StaticResource RoundedTableBorder}" Margin="{StaticResource NoMarginNothing}">
                          <DataGrid x:Name="SupportDataGrid"
                                    ItemsSource="{Binding Schedule.SelectedSupportRows}"
                                    AutoGenerateColumns="False"
                                    CanUserAddRows="False"
                                    CanUserDeleteRows="False"
                                    IsReadOnly="True"
                                    HeadersVisibility="Column"
                                    GridLinesVisibility="Horizontal"
                                    HorizontalGridLinesBrush="{StaticResource SchedGridLineBrush}"
                                    ColumnHeaderStyle="{StaticResource RoundedDataGridColumnHeader}"
                                    CellStyle="{StaticResource DefaultCellStyle}"
                                    BorderThickness="{StaticResource NoBorderThickness}"
                                    Background="{StaticResource TransparentBrush}"
                                    SnapsToDevicePixels="True"
                                    Margin="{StaticResource NoMarginNothing}"
                                    Focusable="True"
                                    PreviewMouseLeftButtonDown="ScheduleArea_PreviewMouseLeftButtonDown">
                            <DataGrid.RowStyle>
                              <Style TargetType="DataGridRow">
                                <Setter Property="Background"
                                        Value="{Binding Kind, Converter={StaticResource TaskKindToBrushConverter},
                                                        FallbackValue={StaticResource TransparentBrush},
                                                        TargetNullValue={StaticResource TransparentBrush}}"/>
                                <Setter Property="SnapsToDevicePixels" Value="True"/>
                              </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.Columns>
                              <DataGridTextColumn Header="Start Time" Binding="{Binding StartText}" Width="*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"/>
                              <DataGridTextColumn Header="Support Staff" Binding="{Binding SupportName}" Width="2*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"/>
                              <DataGridTextColumn Header="Teacher" Binding="{Binding ., Converter={StaticResource SupportTeacherDisplayConverter}}" Width="2*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"/>
                              <DataGridTextColumn Header="Activity" Binding="{Binding TaskName}" Width="*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"/>
                              <DataGridTextColumn Header="Duration" Binding="{Binding DurationText}" Width="*"
                                                  CellStyle="{StaticResource LastColumnCellStyle}"/>
                            </DataGrid.Columns>
                          </DataGrid>
                        </Border>
                      </Grid>
                    </TabItem>

                    <TabItem Header="By Teacher">
                      <!-- By Teacher layout -->
                      <Grid Margin="20">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="260"/>
                          <ColumnDefinition Width="16"/>
                          <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Style="{StaticResource RoundedTableBorder}" Margin="{StaticResource NoMarginNothing}">
                          <ListBox x:Name="TeacherListBox"
                                   beh:AutoSelectFirstBehavior.EnableAutoSelect="True"
                                   ItemsSource="{Binding Setup.Teachers}"
                                   SelectionMode="Extended"
                                   SelectedItem="{Binding Schedule.SelectedTeacher, Mode=TwoWay}"
                                   SelectionChanged="TeacherListBox_SelectionChanged"
                                   ScrollViewer.VerticalScrollBarVisibility="Auto"
                                   Background="{StaticResource TransparentBrush}"
                                   BorderThickness="0"
                                   IsSynchronizedWithCurrentItem="False"
                                   ItemContainerStyle="{StaticResource RoundedListBoxItemStyle}">
                            <ListBox.ItemTemplate>
                              <DataTemplate>
                                <Grid Margin="{StaticResource CellElementMargin}">
                                  <TextBlock Text="{Binding Name}"
                                             FontWeight="SemiBold"
                                             VerticalAlignment="Center"
                                             Margin="8,0,0,0"/>
                                </Grid>
                              </DataTemplate>
                            </ListBox.ItemTemplate>
                          </ListBox>
                        </Border>

                        <Border Grid.Column="2" Style="{StaticResource RoundedTableBorder}" Margin="{StaticResource NoMarginNothing}">
                          <DataGrid x:Name="TeacherDataGrid"
                                    ItemsSource="{Binding Schedule.SelectedTeacherRows}"
                                    AutoGenerateColumns="False"
                                    CanUserAddRows="False"
                                    CanUserDeleteRows="False"
                                    IsReadOnly="True"
                                    HeadersVisibility="Column"
                                    GridLinesVisibility="Horizontal"
                                    HorizontalGridLinesBrush="{StaticResource SchedGridLineBrush}"
                                    ColumnHeaderStyle="{StaticResource RoundedDataGridColumnHeader}"
                                    CellStyle="{StaticResource DefaultCellStyle}"
                                    BorderThickness="{StaticResource NoBorderThickness}"
                                    Background="{StaticResource TransparentBrush}"
                                    SnapsToDevicePixels="True"
                                    Margin="{StaticResource NoMarginNothing}"
                                    Focusable="True"
                                    PreviewMouseLeftButtonDown="ScheduleArea_PreviewMouseLeftButtonDown">
                            <DataGrid.RowStyle>
                              <Style TargetType="DataGridRow">
                                <Setter Property="Background" Value="{Binding Converter={StaticResource TeacherRowToBrushConverter}}"/>
                                <Setter Property="SnapsToDevicePixels" Value="True"/>
                              </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.Columns>
                              <DataGridTextColumn Header="Start Time" Binding="{Binding Start}" Width="*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"/>
                              <DataGridTextColumn Header="Name" Binding="{Binding TeacherName}" Width="2*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"/>
                              <DataGridTextColumn Header="Support Staff" Binding="{Binding SupportStaff}" Width="2*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"/>
                              <DataGridTextColumn Header="Activity" Binding="{Binding Activity}" Width="*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"/>
                              <DataGridTextColumn Header="Duration" Binding="{Binding Duration}" Width="*"
                                                  CellStyle="{StaticResource LastColumnCellStyle}"/>
                            </DataGrid.Columns>
                          </DataGrid>
                        </Border>
                      </Grid>
                    </TabItem>

                    <TabItem Header="Print Preview">
                      <Grid Margin="20">
                        <Grid.RowDefinitions>
                          <RowDefinition Height="Auto"/>
                          <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="{StaticResource ToolbarRowBottomMarginSmall}">
                          <ComboBox Width="200"
                                    ItemsSource="{Binding Schedule.SupportTabs}"
                                    DisplayMemberPath="SupportName"
                                    SelectedItem="{Binding PrintPreview.SelectedTab}" />
                          <Button Content="Print All" Style="{StaticResource IconButton}" Command="{Binding PrintPreview.PrintAllCommand}" Margin="{StaticResource ToolbarButtonMarginLarge}"/>
                          <Button Content="Print Selected" Style="{StaticResource IconButton}" Command="{Binding PrintPreview.PrintSelectedCommand}" Margin="{StaticResource ToolbarButtonMarginSmall}"
                                  IsEnabled="{Binding PrintPreview.SelectedTab, Converter={StaticResource NotNullToTrue}}"/>
                          <Button Content="Export PDF" Style="{StaticResource IconButton}" Command="{Binding PrintPreview.ExportPdfCommand}" Margin="{StaticResource ToolbarButtonMarginSmall}"
                                  IsEnabled="{Binding PrintPreview.SelectedTab, Converter={StaticResource NotNullToTrue}}"/>
                        </StackPanel>

                        <FlowDocumentScrollViewer x:Name="PrintPreviewViewer"
                                                  Grid.Row="1"
                                                  Document="{Binding PrintPreview.Document}"
                                                  Focusable="True"
                                                  PreviewMouseLeftButtonDown="ScheduleArea_PreviewMouseLeftButtonDown" />
                      </Grid>
                    </TabItem>
                  </TabControl>
                </Border>
              </Grid>
            </TabItem>

            <!-- 2) Team Lineup -->
            <TabItem Header="Team Lineup">
              <Grid Margin="{StaticResource PageSectionMarginLarge}">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Team Lineup"
                           FontSize="{StaticResource PageTitleFontSize}"
                           Margin="{StaticResource TitleMarginBottomLarge}"/>

                <Grid Grid.Row="1">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="420" />
                  </Grid.ColumnDefinitions>

                  <TabControl x:Name="SetupInnerTab" Grid.Column="0" Margin="{StaticResource RightColumnGapLarge}">
                    <TabItem Header="Classrooms and Teachers">
                      <Grid Margin="{StaticResource PageSectionMarginLarge}">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <ContentControl Grid.Column="0"
                                        Style="{StaticResource RoundedTableContainer}"
                                        Margin="{StaticResource NoMarginThickness}"
                                        VerticalContentAlignment="Stretch">
                          <DataGrid x:Name="TeachersGrid"
                                    ItemsSource="{Binding Setup.Teachers}"
                                    AutoGenerateColumns="False"
                                    CanUserAddRows="False"
                                    CanUserSortColumns="True"
                                    HeadersVisibility="Column"
                                    SelectionMode="Extended"
                                    SelectionUnit="FullRow"
                                    GridLinesVisibility="Horizontal"
                                    HorizontalGridLinesBrush="{StaticResource SchedGridLineBrush}"
                                    SnapsToDevicePixels="True"
                                    BorderThickness="{StaticResource NoBorderThickness}"
                                    Background="{StaticResource TransparentBrush}"
                                    ColumnHeaderStyle="{StaticResource RoundedDataGridColumnHeader}"
                                    beh:DataGridRowReorderBehavior.EnableRowReorder="True"
                                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                    VerticalAlignment="Stretch">
                            <DataGrid.InputBindings>
                              <KeyBinding Key="Up" Modifiers="Control"
                                          Command="{Binding DataContext.Setup.MoveTeacherUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                              <KeyBinding Key="Down" Modifiers="Control"
                                          Command="{Binding DataContext.Setup.MoveTeacherDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                            </DataGrid.InputBindings>

                            <DataGrid.Resources>
                              <Style TargetType="{x:Type DataGridColumnHeadersPresenter}">
                                <Setter Property="Background" Value="{StaticResource TransparentBrush}"/>
                                <Setter Property="SnapsToDevicePixels" Value="True"/>
                                <Setter Property="ClipToBounds" Value="True"/>
                              </Style>
                            </DataGrid.Resources>

                            <DataGrid.Columns>
                              <DataGridTextColumn Header="Room Number"
                                                  Binding="{Binding RoomNumber}"
                                                  SortMemberPath="RoomNumber"
                                                  Width="*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"
                                                  ElementStyle="{StaticResource DefaultTextElementStyle}"
                                                  EditingElementStyle="{StaticResource DefaultEditingElementStyle}"/>
                              <DataGridTextColumn Header="Teacher Name"
                                                  Binding="{Binding Name}"
                                                  SortMemberPath="Name"
                                                  Width="*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"
                                                  ElementStyle="{StaticResource DefaultTextElementStyle}"
                                                  EditingElementStyle="{StaticResource DefaultEditingElementStyle}"/>
                              <DataGridTemplateColumn Header="Start Time"
                                                      SortMemberPath="Start"
                                                      Width="*"
                                                      CellStyle="{StaticResource DefaultCellStyle}">
                                <DataGridTemplateColumn.CellTemplate>
                                  <DataTemplate>
                                    <TextBlock Text="{Binding Start, Converter={StaticResource TimeSpanToStringConverter}}"
                                               Style="{StaticResource DefaultTextElementStyle}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                  <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.QuarterHours, RelativeSource={RelativeSource AncestorType=Window}}"
                                              SelectedItem="{Binding Start, Mode=TwoWay}"
                                              ItemTemplate="{StaticResource TimeItemTemplate}"
                                              MinWidth="120"
                                              Padding="{StaticResource CellEditorPadding}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                              </DataGridTemplateColumn>

                              <DataGridTemplateColumn Header="End Time" SortMemberPath="End" Width="*"
                                                      CellStyle="{StaticResource LastColumnCellStyle}">
                                <DataGridTemplateColumn.CellTemplate>
                                  <DataTemplate>
                                    <TextBlock Text="{Binding End, Converter={StaticResource TimeSpanToStringConverter}}"
                                               Style="{StaticResource DefaultTextElementStyle}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                  <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.QuarterHours, RelativeSource={RelativeSource AncestorType=Window}}"
                                              SelectedItem="{Binding End, Mode=TwoWay}"
                                              ItemTemplate="{StaticResource TimeItemTemplate}"
                                              MinWidth="120"
                                              Padding="{StaticResource CellEditorPadding}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                              </DataGridTemplateColumn>
                            </DataGrid.Columns>
                          </DataGrid>
                        </ContentControl>

                        <StackPanel Grid.Column="1"
                                    Orientation="Vertical"
                                    Margin="{StaticResource SidePanelLeftMargin}"
                                    VerticalAlignment="Top">
                          <Button Content="Add"
                                  Style="{StaticResource RoundedActionButton}"
                                  Margin="{StaticResource ActionButtonStackMargin}"
                                  Command="{Binding Setup.AddTeacherCommand}"/>
                          <Button Content="Remove"
                                  Style="{StaticResource RoundedActionButton}"
                                  Margin="{StaticResource ActionButtonStackMarginNone}"
                                  Command="{Binding Setup.RemoveTeacherCommand}"
                                  CommandParameter="{Binding SelectedItems, ElementName=TeachersGrid}"/>
                        </StackPanel>
                      </Grid>
                    </TabItem>

                    <TabItem Header="Support Staff">
                      <Grid Margin="{StaticResource PageSectionMarginLarge}">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <ContentControl Grid.Column="0"
                                        Style="{StaticResource RoundedTableContainer}"
                                        Margin="{StaticResource NoMarginThickness}"
                                        VerticalContentAlignment="Stretch">
                          <DataGrid x:Name="SupportsGrid"
                                    ItemsSource="{Binding Setup.Supports}"
                                    SelectedItem="{Binding Setup.SelectedSupport}"
                                    AutoGenerateColumns="False"
                                    CanUserAddRows="False"
                                    CanUserSortColumns="True"
                                    HeadersVisibility="Column"
                                    SelectionMode="Extended"
                                    SelectionUnit="FullRow"
                                    GridLinesVisibility="Horizontal"
                                    HorizontalGridLinesBrush="{StaticResource SchedGridLineBrush}"
                                    SnapsToDevicePixels="True"
                                    BorderThickness="{StaticResource NoBorderThickness}"
                                    Background="{StaticResource TransparentBrush}"
                                    ColumnHeaderStyle="{StaticResource RoundedDataGridColumnHeader}"
                                    beh:DataGridRowReorderBehavior.EnableRowReorder="True"
                                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                    VerticalAlignment="Stretch">

                            <DataGrid.InputBindings>
                              <KeyBinding Key="Up" Modifiers="Control"
                                          Command="{Binding DataContext.Setup.MoveSupportUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                              <KeyBinding Key="Down" Modifiers="Control"
                                          Command="{Binding DataContext.Setup.MoveSupportDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                            </DataGrid.InputBindings>

                            <DataGrid.Columns>
                              <DataGridTextColumn Header="Support Staff"
                                                  Binding="{Binding Name}"
                                                  SortMemberPath="Name"
                                                  Width="*"
                                                  CellStyle="{StaticResource DefaultCellStyle}" />
                              <DataGridTemplateColumn Header="Start Time"
                                                      SortMemberPath="Start"
                                                      Width="*"
                                                      CellStyle="{StaticResource DefaultCellStyle}">
                                <DataGridTemplateColumn.CellTemplate>
                                  <DataTemplate>
                                    <TextBlock Text="{Binding Start, Converter={StaticResource TimeSpanToStringConverter}}"
                                               Style="{StaticResource DefaultTextElementStyle}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                  <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.QuarterHours, RelativeSource={RelativeSource AncestorType=Window}}"
                                              SelectedItem="{Binding Start, Mode=TwoWay}"
                                              ItemTemplate="{StaticResource TimeItemTemplate}"
                                              MinWidth="120"
                                              Padding="{StaticResource CellEditorPadding}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                              </DataGridTemplateColumn>

                              <DataGridTemplateColumn Header="End Time"
                                                      SortMemberPath="End"
                                                      Width="*"
                                                      CellStyle="{StaticResource LastColumnCellStyle}">
                                <DataGridTemplateColumn.CellTemplate>
                                  <DataTemplate>
                                    <TextBlock Text="{Binding End, Converter={StaticResource TimeSpanToStringConverter}}"
                                               Style="{StaticResource DefaultTextElementStyle}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                  <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.QuarterHours, RelativeSource={RelativeSource AncestorType=Window}}"
                                              SelectedItem="{Binding End, Mode=TwoWay}"
                                              ItemTemplate="{StaticResource TimeItemTemplate}"
                                              MinWidth="120"
                                              Padding="{StaticResource CellEditorPadding}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                              </DataGridTemplateColumn>
                            </DataGrid.Columns>
                          </DataGrid>
                        </ContentControl>

                        <StackPanel Grid.Column="1"
                                    Orientation="Vertical"
                                    Margin="{StaticResource SidePanelLeftMargin}"
                                    VerticalAlignment="Top">
                          <Button Content="Add"
                                  Style="{StaticResource RoundedActionButton}"
                                  Margin="{StaticResource ActionButtonStackMargin}"
                                  Command="{Binding Setup.AddSupportCommand}"/>
                          <Button Content="Remove"
                                  Style="{StaticResource RoundedActionButton}"
                                  Margin="{StaticResource ActionButtonStackMarginNone}"
                                  Command="{Binding Setup.RemoveSupportCommand}"
                                  CommandParameter="{Binding SelectedItems, ElementName=SupportsGrid}"/>
                        </StackPanel>
                      </Grid>
                    </TabItem>

                    <TabItem Header="Support Matchups">
                      <Grid Margin="{StaticResource PageSectionMarginLarge}">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <ContentControl Grid.Column="0"
                                        Style="{StaticResource RoundedTableContainer}"
                                        Margin="{StaticResource NoMarginThickness}"
                                        VerticalContentAlignment="Stretch">
                          <DataGrid x:Name="PrefsGrid"
                                    ItemsSource="{Binding Setup.Preferences}"
                                    SelectedItem="{Binding Setup.SelectedPreference}"
                                    AutoGenerateColumns="False"
                                    CanUserAddRows="False"
                                    CanUserSortColumns="True"
                                    HeadersVisibility="Column"
                                    SelectionMode="Extended"
                                    SelectionUnit="FullRow"
                                    GridLinesVisibility="Horizontal"
                                    HorizontalGridLinesBrush="{StaticResource SchedGridLineBrush}"
                                    SnapsToDevicePixels="True"
                                    BorderThickness="{StaticResource NoBorderThickness}"
                                    Background="{StaticResource TransparentBrush}"
                                    ColumnHeaderStyle="{StaticResource RoundedDataGridColumnHeader}"
                                    beh:DataGridRowReorderBehavior.EnableRowReorder="True"
                                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                    VerticalAlignment="Stretch">

                            <DataGrid.InputBindings>
                              <KeyBinding Key="Up" Modifiers="Control"
                                          Command="{Binding DataContext.Setup.MovePreferenceUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                              <KeyBinding Key="Down" Modifiers="Control"
                                          Command="{Binding DataContext.Setup.MovePreferenceDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                            </DataGrid.InputBindings>

                            <DataGrid.Resources>
                              <Style TargetType="{x:Type DataGridColumnHeadersPresenter}">
                                <Setter Property="Background" Value="{StaticResource TransparentBrush}"/>
                                <Setter Property="SnapsToDevicePixels" Value="True"/>
                                <Setter Property="ClipToBounds" Value="True"/>
                              </Style>
                            </DataGrid.Resources>

                            <DataGrid.Columns>
                              <DataGridTextColumn Header="Room Number"
                                                  Binding="{Binding RoomNumber}"
                                                  SortMemberPath="RoomNumber"
                                                  Width="*"
                                                  CellStyle="{StaticResource DefaultCellStyle}"
                                                  ElementStyle="{StaticResource DefaultTextElementStyle}"
                                                  EditingElementStyle="{StaticResource DefaultEditingElementStyle}"/>
                              <DataGridTemplateColumn Header="Preferred Support Staff"
                                                      SortMemberPath="PreferredSupportName"
                                                      Width="*"
                                                      CellStyle="{StaticResource LastColumnCellStyle}">
                                <DataGridTemplateColumn.CellTemplate>
                                  <DataTemplate>
                                    <TextBlock Text="{Binding PreferredSupportName}" Margin="{StaticResource CellElementMargin}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                  <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Setup.Supports, RelativeSource={RelativeSource AncestorType=Window}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Name"
                                              SelectedValue="{Binding PreferredSupportName}"
                                              Margin="{StaticResource CellElementMargin}"/>
                                  </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                              </DataGridTemplateColumn>
                            </DataGrid.Columns>
                          </DataGrid>
                        </ContentControl>

                        <StackPanel Grid.Column="1"
                                    Orientation="Vertical"
                                    Margin="{StaticResource SidePanelLeftMargin}"
                                    VerticalAlignment="Top">
                          <Button Content="Add"
                                  Style="{StaticResource RoundedActionButton}"
                                  Margin="{StaticResource ActionButtonStackMargin}"
                                  Command="{Binding Setup.AddPreferenceCommand}"/>
                          <Button Content="Remove"
                                  Style="{StaticResource RoundedActionButton}"
                                  Margin="{StaticResource ActionButtonStackMarginNone}"
                                  Command="{Binding Setup.RemovePreferenceCommand}"
                                  CommandParameter="{Binding SelectedItems, ElementName=PrefsGrid}"/>
                        </StackPanel>
                      </Grid>
                    </TabItem>
                  </TabControl>
                  <Grid Grid.Column="1" Margin="{StaticResource NoMarginNothing}">
                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center">
                      <Button Content="Generate Schedule"
                              Style="{StaticResource IconButton}"
                              MinWidth="260" Height="44"
                              Margin="{StaticResource PrimaryActionMarginBottomLarge}"
                              Command="{Binding GenerateScheduleCommand}"/>
                      <Button Content="Load Data"
                              Style="{StaticResource IconButton}"
                              MinWidth="260" Height="44"
                              Margin="{StaticResource PrimaryActionMarginBottomLarge}"
                              Command="{Binding LoadSetupCommand}"/>
                      <Button Content="Save Data"
                              Style="{StaticResource IconButton}"
                              MinWidth="260" Height="44"
                              Margin="{StaticResource NoMarginNothing}"
                              Command="{Binding SaveSetupCommand}"/>
                    </StackPanel>
                  </Grid>
                </Grid>
              </Grid>
            </TabItem>

            <!-- 3) School Details moved to top-level -->
            <TabItem Header="Preferences">
              <Grid Margin="{StaticResource PageSectionMarginLarge}">
                <ContentControl Margin="{StaticResource NoMarginThickness}">
                  <Grid Margin="{StaticResource FormInnerMargin}">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto"/>
                      <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                      <RowDefinition Height="Auto"/>
                      <RowDefinition Height="Auto"/>
                      <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Margin="{StaticResource FormLabelMargin}" VerticalAlignment="Center" Text="School Name"/>
                    <TextBox   Grid.Row="0" Grid.Column="1" Margin="{StaticResource FormFieldMarginBottom}"
                               Text="{Binding Setup.SchoolName, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Margin="{StaticResource FormLabelMargin}" VerticalAlignment="Top" Text="Address"/>
                    <TextBox   Grid.Row="1" Grid.Column="1" Margin="{StaticResource FormFieldMarginBottom}"
                               Text="{Binding Setup.SchoolAddress, UpdateSourceTrigger=PropertyChanged}"
                               AcceptsReturn="True"
                               TextWrapping="Wrap"
                               VerticalScrollBarVisibility="Auto"
                               MinLines="4"
                               MaxLines="4"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Margin="{StaticResource FormLabelMarginLastRow}" VerticalAlignment="Center" Text="Telephone"/>
                    <TextBox   Grid.Row="2" Grid.Column="1"
                               Text="{Binding Setup.SchoolPhone, UpdateSourceTrigger=PropertyChanged}"/>
                  </Grid>
                </ContentControl>
              </Grid>
            </TabItem>

            <!-- other top-level tabs could go here -->
          </TabControl>
        </Grid>
      </Border>
    </DockPanel>

    <Grid x:Name="ResizeOverlay"
          Margin="3"
          Background="{x:Null}"
          IsHitTestVisible="True"
          ClipToBounds="True"
          Panel.ZIndex="10000"
          HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch"
          SnapsToDevicePixels="True">

      <!-- Left / Right (8px wide) -->
      <Thumb x:Name="ThumbLeft"
             Background="Transparent"
             Style="{StaticResource VisibleResizeThumbStyle}"
             IsHitTestVisible="True"
             Tag="Left"
             Width="8"
             HorizontalAlignment="Left"
             VerticalAlignment="Stretch"
             Cursor="SizeWE"
             PreviewMouseDown="ResizeThumb_PreviewMouseDown"
             DragDelta="ThumbLeft_DragDelta"/>

      <Thumb x:Name="ThumbRight"
             Background="Transparent"
             Style="{StaticResource VisibleResizeThumbStyle}"
             IsHitTestVisible="True"
             Tag="Right"
             Width="8"
             HorizontalAlignment="Right"
             VerticalAlignment="Stretch"
             Cursor="SizeWE"
             PreviewMouseDown="ResizeThumb_PreviewMouseDown"
             DragDelta="ThumbRight_DragDelta"/>

      <!-- Top / Bottom (6px high) -->
      <Thumb x:Name="ThumbTop"
             Background="Transparent"
             Style="{StaticResource VisibleResizeThumbStyle}"
             IsHitTestVisible="True"
             Tag="Top"
             Height="6"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Top"
             Cursor="SizeNS"
             PreviewMouseDown="ResizeThumb_PreviewMouseDown"
             DragDelta="ThumbTop_DragDelta"/>

      <Thumb x:Name="ThumbBottom"
             Background="Transparent"
             Style="{StaticResource VisibleResizeThumbStyle}"
             IsHitTestVisible="True"
             Tag="Bottom"
             Height="6"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Bottom"
             Cursor="SizeNS"
             PreviewMouseDown="ResizeThumb_PreviewMouseDown"
             DragDelta="ThumbBottom_DragDelta"/>

      <!-- Corners (12x12) -->
      <Thumb x:Name="ThumbTopLeft"
             Background="Transparent"
             Style="{StaticResource VisibleResizeThumbStyle}"
             IsHitTestVisible="True"
             Tag="TopLeft"
             Width="12" Height="12"
             HorizontalAlignment="Left"
             VerticalAlignment="Top"
             Cursor="SizeNWSE"
             PreviewMouseDown="ResizeThumb_PreviewMouseDown"
             DragDelta="ThumbTopLeft_DragDelta"/>

      <Thumb x:Name="ThumbTopRight"
             Background="Transparent"
             Style="{StaticResource VisibleResizeThumbStyle}"
             IsHitTestVisible="True"
             Tag="TopRight"
             Width="12" Height="12"
             HorizontalAlignment="Right"
             VerticalAlignment="Top"
             Cursor="SizeNESW"
             PreviewMouseDown="ResizeThumb_PreviewMouseDown"
             DragDelta="ThumbTopRight_DragDelta"/>

      <Thumb x:Name="ThumbBottomLeft"
             Background="Transparent"
             Style="{StaticResource VisibleResizeThumbStyle}"
             IsHitTestVisible="True"
             Tag="BottomLeft"
             Width="12" Height="12"
             HorizontalAlignment="Left"
             VerticalAlignment="Bottom"
             Cursor="SizeNESW"
             PreviewMouseDown="ResizeThumb_PreviewMouseDown"
             DragDelta="ThumbBottomLeft_DragDelta"/>

      <Thumb x:Name="ThumbBottomRight"
             Background="Transparent"
             Style="{StaticResource VisibleResizeThumbStyle}"
             IsHitTestVisible="True"
             Tag="BottomRight"
             Width="12" Height="12"
             HorizontalAlignment="Right"
             VerticalAlignment="Bottom"
             Cursor="SizeNWSE"
             PreviewMouseDown="ResizeThumb_PreviewMouseDown"
             DragDelta="ThumbBottomRight_DragDelta"/>
    </Grid>
  </Grid>
</Window>
